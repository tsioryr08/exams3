# ğŸ“‹ Version 2 - FonctionnalitÃ© ACHATS

## ğŸ¯ RÃ©sumÃ© de la fonctionnalitÃ©

Cette version ajoute la possibilitÃ© d'**acheter des besoins** (nature et matÃ©riel) avec les **dons en argent** disponibles, avec un **systÃ¨me de simulation** avant validation et une **page de rÃ©capitulation** en temps rÃ©el.

---

## ğŸ“ FICHIERS CRÃ‰Ã‰S

### Base de donnÃ©es
- `database/baseV2.sql` - Script SQL pour les modifications de la base de donnÃ©es

### Repositories (Couche d'accÃ¨s aux donnÃ©es)
- `app/repositories/ConfigRepository.php` - Gestion de la configuration systÃ¨me
- `app/repositories/AchatRepository.php` - Gestion des achats
- `app/repositories/RecapRepository.php` - Statistiques et rÃ©capitulatifs

### Services (Logique mÃ©tier)
- `app/services/AchatService.php` - Logique des achats (simulation, validation)
- `app/services/RecapService.php` - Logique des statistiques

### Controllers (Gestion des requÃªtes)
- `app/controllers/AchatController.php` - ContrÃ´leur des achats
- `app/controllers/RecapController.php` - ContrÃ´leur du rÃ©capitulatif

### Vues (Interface utilisateur)
- `app/views/achats/besoins_restants.php` - Page de sÃ©lection des besoins Ã  acheter
- `app/views/achats/simulation.php` - Page de simulation des achats
- `app/views/achats/liste.php` - Liste des achats effectuÃ©s
- `app/views/recap/index.php` - Page de rÃ©capitulation avec Ajax

---

## âœï¸ FICHIERS MODIFIÃ‰S

### Fichiers principaux
- `app/routes.php` - Ajout des routes pour achats et rÃ©capitulatif

### Repositories modifiÃ©s
- `app/repositories/BesoinRepository.php` - Ajout des mÃ©thodes :
  - `getBesoinsRestants()` - RÃ©cupÃ©rer les besoins non satisfaits
  - `getMontantTotalBesoins()` - Calculer le montant total des besoins

- `app/repositories/DispatchRepository.php` - Ajout de la mÃ©thode :
  - `createFromAchat()` - CrÃ©er un dispatch depuis un achat

### Vue corrigÃ©e
- `app/views/besoins/list.php` - Correction de l'erreur `match()` (PHP 8.0+) remplacÃ© par `if/elseif`

---

## ğŸ—„ï¸ MODIFICATIONS BASE DE DONNÃ‰ES (baseV2.sql)

### Nouvelles tables
1. **`config`** - Configuration systÃ¨me
   - Stocke le pourcentage de frais d'achat (configurable)

2. **`achats`** - Historique des achats
   - Enregistre tous les achats effectuÃ©s avec les dons en argent
   - Champs : ville, besoin, type, libellÃ©, quantitÃ©, prix, montants, frais, statut

### Tables modifiÃ©es
1. **`dispatch`** - Ajout de colonnes :
   - `source` - Distingue entre 'don_direct' et 'achat'
   - `achat_id` - RÃ©fÃ©rence Ã  l'achat si source = achat

### Vues crÃ©Ã©es
1. **`v_besoins_restants`** - Besoins non satisfaits (achetables)
2. **`v_argent_disponible`** - Dons en argent disponibles
3. **`v_recapitulatif`** - Statistiques globales

---

## ğŸŒ NOUVELLES ROUTES

### Routes ACHATS
- `GET /achats/besoins-restants` - Afficher les besoins Ã  acheter (filtrable par ville)
- `POST /achats/simuler` - Simuler des achats
- `POST /achats/valider` - Valider et enregistrer les achats
- `GET /achats/liste` - Liste des achats effectuÃ©s

### Routes RÃ‰CAPITULATIF
- `GET /recap` - Page de rÃ©capitulation globale
- `GET /recap/ajax` - Endpoint Ajax pour actualiser les stats

---

## ğŸš€ FONCTIONNALITÃ‰S IMPLÃ‰MENTÃ‰ES

### 1. **Achats de Besoins**
- âœ… Affichage des besoins restants (non satisfaits)
- âœ… Filtre par ville
- âœ… Calcul automatique des frais d'achat (configurable)
- âœ… VÃ©rification de l'argent disponible
- âœ… SÃ©lection multiple avec checkbox
- âœ… Indication visuelle (vert = achetable, rouge = argent insuffisant)

### 2. **Simulation d'Achats**
- âœ… AperÃ§u des achats avant validation
- âœ… Calcul des montants HT, frais, TTC
- âœ… VÃ©rification des erreurs (don direct existant, argent insuffisant)
- âœ… Tableau dÃ©taillÃ© des achats simulÃ©s
- âœ… PossibilitÃ© de retour en arriÃ¨re

### 3. **Validation d'Achats**
- âœ… Enregistrement en base de donnÃ©es
- âœ… CrÃ©ation automatique des dispatches associÃ©s
- âœ… Transaction SQL pour garantir la cohÃ©rence
- âœ… Messages de confirmation/erreur

### 4. **Page de RÃ©capitulation**
- âœ… Statistiques globales (besoins totaux, satisfaits, restants)
- âœ… Barre de progression de satisfaction
- âœ… Informations sur l'argent (total, utilisÃ©, disponible)
- âœ… Statistiques par ville avec pourcentage
- âœ… **Bouton "Actualiser" en Ajax** pour mise Ã  jour en temps rÃ©el
- âœ… Interface moderne et intuitive

---

## ğŸ“Š WORKFLOW COMPLET

```
1. BESOINS RESTANTS
   â””â”€> Afficher les besoins non satisfaits
   â””â”€> SÃ©lectionner ceux Ã  acheter
   â””â”€> Cliquer sur "Simuler"

2. SIMULATION
   â””â”€> Voir le rÃ©sultat dÃ©taillÃ©
   â””â”€> VÃ©rifier les montants
   â””â”€> Soit "Retour" soit "Valider"

3. VALIDATION
   â””â”€> Enregistrement des achats
   â””â”€> CrÃ©ation des dispatches
   â””â”€> Redirection vers la liste des achats

4. RÃ‰CAPITULATION
   â””â”€> Vue d'ensemble globale
   â””â”€> Actualisation Ajax en temps rÃ©el
   â””â”€> Statistiques par ville
```

---

## ğŸ¨ INTERFACE UTILISATEUR

Toutes les pages incluent :
- âœ… Design moderne avec dÃ©gradÃ©s et ombres
- âœ… Interface responsive (mobile-friendly)
- âœ… IcÃ´nes emoji pour meilleure lisibilitÃ©
- âœ… Messages de feedback clairs
- âœ… Animations et transitions fluides
- âœ… Code JavaScript pour interactivitÃ©

---

## ğŸ”§ CONFIGURATION

Le pourcentage de frais d'achat est **configurable** via la table `config` :
```sql
UPDATE config SET valeur = '15' WHERE cle = 'frais_achat_pourcentage';
```
Par dÃ©faut : **10%**

---

## âœ… TESTS RECOMMANDÃ‰S

1. Appliquer le script `baseV2.sql`
2. VÃ©rifier que les tables sont crÃ©Ã©es
3. Tester la page `/achats/besoins-restants`
4. Simuler des achats
5. Valider des achats
6. Consulter `/recap` et tester le bouton Ajax
7. VÃ©rifier que les dispatches sont bien crÃ©Ã©s

---

## ğŸ“Œ NOTES IMPORTANTES

- Les achats utilisent l'argent des dons de type "argent"
- Seuls les besoins en "nature" et "matÃ©riel" sont achetables
- Un message d'erreur s'affiche si un don direct existe dÃ©jÃ  pour ce besoin
- Les frais d'achat sont automatiquement ajoutÃ©s au montant
- La simulation ne modifie pas la base de donnÃ©es
- L'Ajax permet d'actualiser les stats sans recharger la page

---

**ğŸ“… Date de crÃ©ation :** 16 fÃ©vrier 2026  
**ğŸ”– Version :** 2.0  
**ğŸ‘¥ DÃ©veloppÃ© par :** GitHub Copilot
